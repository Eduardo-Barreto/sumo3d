<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Sumo VR - All Japan Style</title>
    <meta name="description" content="Immersive experience of piloting a sumo robot in All Japan Robot Sumo Tournament style">
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="hud" role="complementary" aria-label="Game controls">
        <h1 class="hud-title">Robot Sumo</h1>
        <ul class="hud-controls" aria-label="Controls list">
            <li><span class="key" data-key="KeyW">W</span><span class="key" data-key="KeyA">A</span><span class="key" data-key="KeyS">S</span><span class="key" data-key="KeyD">D</span> Move</li>
            <li><span class="key" data-key="KeyV">V</span> FPV Camera</li>
            <li><span class="key" data-key="KeyR">R</span> Reset</li>
            <li><span class="key" data-key="KeyJ">J</span> Toggle Joysticks</li>
        </ul>
        <div class="hud-status" id="status" aria-live="polite"></div>
    </div>

    <button class="multiplayer-btn" id="multiplayer-btn">Multiplayer</button>
    <button class="settings-btn" id="settings-btn">⚙</button>

    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <span>Settings</span>
            <button class="settings-close" id="settings-close">×</button>
        </div>
        <div class="settings-item">
            <label>Normal Speed</label>
            <input type="range" id="setting-normal-speed" min="0.5" max="2" step="0.1" value="1.7">
            <span class="settings-value" id="value-normal-speed">1.7</span>
            <button class="settings-reset" id="reset-normal-speed" data-default="1.7">↺</button>
        </div>
        <div class="settings-item">
            <label>Slow Speed (Trigger)</label>
            <input type="range" id="setting-slow-speed" min="0.1" max="1" step="0.1" value="0.3">
            <span class="settings-value" id="value-slow-speed">0.3</span>
            <button class="settings-reset" id="reset-slow-speed" data-default="0.3">↺</button>
        </div>
        <div class="settings-item">
            <label>Obstacle (Single Player)</label>
            <select id="setting-obstacle">
                <option value="box">Box</option>
                <option value="cones">Cones</option>
                <option value="laser">Laser</option>
                <option value="none">None</option>
            </select>
        </div>
        <div class="settings-item">
            <label>Obstacle Difficulty</label>
            <input type="range" id="setting-obstacle-difficulty" min="1" max="10" step="1" value="5">
            <span class="settings-value" id="value-obstacle-difficulty">5</span>
            <button class="settings-reset" id="reset-obstacle-difficulty" data-default="5">↺</button>
        </div>
    </div>

    <div class="fpv-indicator" id="fpv-indicator">FPV</div>

    <div class="score-display" id="score-display">
        <div class="score-value" id="score-value">0 × 0</div>
        <div class="score-label">Best of 3</div>
    </div>

    <!-- Virtual Joysticks -->
    <div class="joysticks-container" id="joysticks-container">
        <div class="joystick left" id="joystick-left">
            <div class="joystick-base">
                <div class="joystick-stick"></div>
            </div>
            <div class="joystick-label">Left</div>
        </div>
        <div class="joystick right" id="joystick-right">
            <div class="joystick-base">
                <div class="joystick-stick"></div>
            </div>
            <div class="joystick-label">Right</div>
        </div>
    </div>

    <!-- Modal Multiplayer -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <h2 class="modal-title">Multiplayer</h2>

            <!-- Menu -->
            <div class="modal-section active" id="section-menu">
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="btn-create">Create Room</button>
                    <button class="modal-btn" id="btn-join">Join Room</button>
                </div>
            </div>

            <!-- Create Room - Step 1: Nickname -->
            <div class="modal-section" id="section-create-nickname">
                <input
                    type="text"
                    class="nickname-input"
                    id="create-nickname-input"
                    placeholder="Your name"
                    maxlength="12"
                    autocomplete="off"
                    spellcheck="false">
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="btn-create-submit">Create Room</button>
                    <button class="modal-btn btn-back">Back</button>
                </div>
            </div>

            <!-- Create Room - Step 2: Waiting -->
            <div class="modal-section" id="section-create-waiting">
                <div class="room-code">
                    <div class="room-code-label">Room Code</div>
                    <div class="room-code-value" id="room-code-value">------</div>
                    <button class="copy-url-btn" id="btn-copy-url">Copy Link</button>
                </div>
                <p class="waiting-text">Waiting for player...</p>
                <div class="modal-buttons">
                    <button class="modal-btn btn-back">Cancel</button>
                </div>
            </div>

            <!-- Join Room -->
            <div class="modal-section" id="section-join">
                <input
                    type="text"
                    class="nickname-input"
                    id="join-nickname-input"
                    placeholder="Your name"
                    maxlength="12"
                    autocomplete="off"
                    spellcheck="false">
                <input
                    type="text"
                    class="join-input"
                    id="join-code-input"
                    placeholder="ROOM CODE"
                    maxlength="6"
                    autocomplete="off"
                    spellcheck="false">
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="btn-join-submit">Join</button>
                    <button class="modal-btn btn-back">Back</button>
                </div>
            </div>

            <!-- Joining -->
            <div class="modal-section" id="section-joining">
                <p class="waiting-text">Connecting...</p>
            </div>

            <!-- Connected -->
            <div class="modal-section" id="section-connected">
                <div class="room-code">
                    <div class="room-code-label">Connected</div>
                    <div class="score-value" id="modal-score">0 × 0</div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn danger" id="btn-disconnect">Disconnect</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Match End Overlay -->
    <div class="match-end-overlay" id="match-end-overlay">
        <div class="match-result" id="match-result">Victory!</div>
        <button class="modal-btn primary" id="btn-rematch">Play Again</button>
    </div>

    <!-- Countdown Overlay -->
    <div class="countdown-overlay" id="countdown-overlay">
        <div class="countdown-number" id="countdown-number">3</div>
    </div>

    <script src="js/constants.js"></script>
    <script src="js/input.js"></script>
    <script src="js/multiplayer.js"></script>
    <script src="js/remote-robot.js"></script>
    <script src="js/game.js"></script>
    <script src="js/box.js"></script>
    <script src="js/laser.js"></script>
    <script src="js/ui.js"></script>

    <a-scene
        background="color: #050505"
        shadow="type: pcfsoft"
        vr-mode-ui="enabled: true"
        loading-screen="dotsColor: #0ff; backgroundColor: #000">

        <!-- Lighting -->
        <a-entity light="type: directional; intensity: 3; color: #fff" position="1 3 2"></a-entity>
        <a-entity light="type: directional; intensity: 2; color: #fff" position="-1 3 2"></a-entity>

        <!-- Arena -->
        <a-entity id="arena" position="0 0 0">
            <!-- Dohyo: 154cm diameter = 0.77m radius -->
            <a-cylinder
                id="dohyo"
                radius="0.77"
                height="0.20"
                segments-radial="64"
                position="0 0.10 0"
                color="#111"
                material="roughness: 0.9"
                shadow="receive: true">
            </a-cylinder>

            <!-- Tawara (white border ring) -->
            <a-ring
                radius-inner="0.72"
                radius-outer="0.77"
                segments-theta="64"
                position="0 0.201 0"
                rotation="-90 0 0"
                color="#FFF"
                material="shader: flat">
            </a-ring>

            <!-- Shikiri lines (starting lines) -->
            <a-box position="0 0.202 -0.15" width="0.20" depth="0.02" height="0.001" color="#A52" material="shader: flat"></a-box>
            <a-box position="0 0.202 0.15" width="0.20" depth="0.02" height="0.001" color="#A52" material="shader: flat"></a-box>

            <!-- Safety zones -->
            <a-box position="0.95 0.025 0" width="1.8" depth="4" height="0.05" material="color: #aa0000; emissive: #440000" shadow="receive: true"></a-box>
            <a-box position="-0.95 0.025 0" width="1.8" depth="4" height="0.05" material="color: #0000aa; emissive: #000044" shadow="receive: true"></a-box>

            <!-- Side ramps -->
            <a-box position="1.5 -0.3 0" rotation="0 0 -20" width="0.8" depth="3" height="0.05" color="#400"></a-box>
            <a-box position="-1.5 -0.3 0" rotation="0 0 20" width="0.8" depth="3" height="0.05" color="#004"></a-box>

            <!-- Floor -->
            <a-plane position="0 -0.01 0" rotation="-90 0 0" width="10" height="10" color="#0a0a0a" shadow="receive: true"></a-plane>
        </a-entity>

        <!-- Local Robot (Host: Sul) -->
        <a-entity
            id="robot-player"
            position="0 0.24 0.4"
            rotation="0 180 0"
            sumo-controls
            xr-input-monitor
            shadow="cast: true">
            <a-box
                class="robot-body"
                width="0.19"
                height="0.08"
                depth="0.16"
                color="#555"
                material="roughness: 0.8">
            </a-box>
            <a-plane
                class="robot-panel"
                width="0.17"
                height="0.06"
                position="0 0 -0.081"
                rotation="0 180 0"
                color="#333">
            </a-plane>
            <a-box
                class="robot-wedge"
                position="0 -0.035 -0.095"
                width="0.20"
                height="0.008"
                depth="0.04"
                rotation="-12 0 0"
                color="#444"
                material="metalness: 0.5; roughness: 0.5">
            </a-box>
        </a-entity>

        <!-- Remote Robot (Guest: Norte) - Hidden by default -->
        <a-entity
            id="remote-robot"
            position="0 0.24 -0.4"
            rotation="0 0 0"
            remote-robot="enabled: false"
            visible="false"
            shadow="cast: true">
            <a-box
                class="robot-body"
                width="0.19"
                height="0.08"
                depth="0.16"
                color="#8b4a4a"
                material="roughness: 0.8">
            </a-box>
            <a-plane
                class="robot-panel"
                width="0.17"
                height="0.06"
                position="0 0 -0.081"
                rotation="0 180 0"
                color="#5c2d2d">
            </a-plane>
            <a-box
                class="robot-wedge"
                position="0 -0.035 -0.095"
                width="0.20"
                height="0.008"
                depth="0.04"
                rotation="-12 0 0"
                color="#6b3d3d"
                material="metalness: 0.5; roughness: 0.5">
            </a-box>
        </a-entity>

        <!-- Cardboard Box -->
        <a-entity
            id="cardboard-box"
            position="0 0.28 -0.4"
            pushable-box
            shadow="cast: true">
            <a-box
                width="0.16"
                height="0.16"
                depth="0.16"
                color="#c4a574"
                material="roughness: 1">
            </a-box>
            <a-box
                position="0 0.081 0"
                width="0.032"
                height="0.002"
                depth="0.162"
                color="#d4a855"
                material="shader: flat">
            </a-box>
            <a-box
                position="0 0 -0.081"
                width="0.032"
                height="0.162"
                depth="0.002"
                color="#d4a855"
                material="shader: flat">
            </a-box>
            <a-box position="0 0.078 -0.04" width="0.158" height="0.001" depth="0.002" color="#a08050" material="shader: flat"></a-box>
            <a-box position="0 0.078 0.04" width="0.158" height="0.001" depth="0.002" color="#a08050" material="shader: flat"></a-box>
        </a-entity>

        <!-- Training Cones (hidden by default) -->
        <a-entity id="training-cones" visible="false">
            <a-cone
                class="training-cone"
                position="0 0.26 -0.30"
                radius-bottom="0.06"
                radius-top="0.015"
                height="0.12"
                color="#ff6600"
                material="roughness: 0.8"
                shadow="cast: true">
            </a-cone>
            <a-cone
                class="training-cone"
                position="0 0.26 0.30"
                radius-bottom="0.06"
                radius-top="0.015"
                height="0.12"
                color="#ff6600"
                material="roughness: 0.8"
                shadow="cast: true">
            </a-cone>
        </a-entity>

        <!-- Laser Chase (hidden by default) -->
        <a-entity
            id="laser-target"
            position="0 0.21 -0.3"
            laser-chase
            visible="false">
            <a-sphere
                radius="0.025"
                color="#ff0044"
            </a-sphere>
        </a-entity>

        <!-- Camera -->
        <a-entity id="player-rig" position="0 0 2.2" rotation="-35 0 0">
            <a-camera
                look-controls="pointerLockEnabled: true"
                wasd-controls="enabled: false">
            </a-camera>
        </a-entity>

    </a-scene>
</body>
</html>
